<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Schematic Highlighter — Docking + Tabs (v3.2f: annotation editor fix)</title>
<style>
:root{--bg:#0f1115;--panel:#161a22;--text:#e8eef7;--muted:#9fb0c3;--accent:#6bb2ff;--btn:#222838;--btnHover:#2b3347;--ok:#35c46a;--bad:#ff6b6b;--left:380px;--right:420px;--bottom:280px;--split:8px;
  --headerH: 60px;
}
*{box-sizing:border-box}html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol"}
header{padding:12px 16px;background:linear-gradient(180deg,#0d1016,#0f1219);border-bottom:1px solid #1f2533;box-shadow:0 2px 12px rgba(0,0,0,.35);position:sticky;top:0;z-index:10;display:flex;align-items:center;gap:12px}
header .toolbar{display:flex;gap:8px;align-items:center}
header .toolbar-left{margin-right:8px}
header .toolbar-center{margin:0 auto}
header .toolbar-right{margin-left:8px}
header h1{margin:0;font-size:18px;font-weight:600;letter-spacing:.2px;flex:1}
header .toolbar button{appearance:none;background:var(--btn);color:var(--text);border:1px solid #2a3145;border-radius:8px;padding:6px 10px;font-size:13px;cursor:pointer}
header .toolbar button:hover{background:var(--btnHover)}
header .toolbar button.active{outline:2px solid #3a4a7a}
.dock{height:calc(100% - var(--headerH));display:grid;grid-template-columns:var(--left) var(--split) 1fr var(--split) var(--right);grid-template-rows:1fr var(--split) var(--bottom);grid-template-areas:"left splitL main splitR right" "left splitL splitB splitR right" "left splitL bottom splitR right";gap:0;padding:12px}
.panel{background:var(--panel);border:1px solid #1f2533;border-radius:10px;padding:12px;display:flex;flex-direction:column;gap:12px;box-shadow:0 6px 24px rgba(0,0,0,.2);min-width:0;overflow:auto}
.panel h2{font-size:15px;margin:0 0 4px;color:var(--muted);font-weight:600}
.panel .row{display:grid;grid-template-columns:1fr auto;align-items:center;gap:10px}
.panel input[type=file],.panel input[type=range],.panel input[type=number],.panel input[type=text]{width:100%}
.panel output{font-variant-numeric:tabular-nums;min-width:46px;text-align:right;color:var(--accent)}
.panel button{appearance:none;background:var(--btn);color:var(--text);border:1px solid #2a3145;border-radius:8px;padding:8px 10px;font-size:14px;cursor:pointer;transition:background .15s ease,transform .015s ease}
.panel button:hover{background:var(--btnHover)}.panel button:active{transform:translateY(1px)}
.hint{font-size:12px;color:var(--muted);line-height:1.35}
.kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;background:#111521;border:1px solid #2a3145;border-radius:6px;padding:1px 6px;font-size:12px;color:#dbe6ff}
.drop{border:1px dashed #2a3145;border-radius:8px;padding:8px;text-align:center;color:#a7b6cc}.drop.drag{background:#111521;color:#cfe1ff}
.tabs{display:flex;gap:6px;flex-wrap:wrap}.tabs button{background:#121722;border:1px solid #263048;color:#cfe1ff;padding:6px 10px;border-radius:8px;font-size:13px;cursor:pointer}.tabs button.active{background:#1b2233;outline:2px solid #3a4a7a}
.tabpane{display:none}.tabpane.active{display:block}.sep{height:1px;background:#233049;margin:4px 0 8px}
.layerList{display:flex;flex-direction:column;gap:8px}
.layerItem{display:grid;grid-template-columns:auto 1fr auto;gap:8px;align-items:center;padding:8px;border:1px solid #25324a;border-radius:8px;background:#0f141e}
.layerItem.active{border-color:#3a4a7a;background:#121a29}
.layerName{font-size:13px;color:#e6eefc}.eye{width:22px;height:22px;border-radius:6px;border:1px solid #2a3145;background:#0f141e;cursor:pointer}.eye.on::after{content:"👁";display:block;text-align:center;line-height:20px}.eye.off::after{content:"🚫";display:block;text-align:center;line-height:20px}
#consoleOut,#historyList{font:12px ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#0c101a;border:1px solid #24304a;border-radius:8px;padding:8px;max-height:160px;overflow:auto;white-space:pre-wrap}
.footer{font-size:12px;color:var(--muted);text-align:center;margin-top:4px}
.splitter{background:transparent;position:relative;z-index:3}.splitter:hover::after{background:#2a3145}.splitter::after{content:"";position:absolute;background:#1b2233;border-radius:3px;opacity:.9}
.splitter.v{cursor:col-resize}.splitter.v.left{grid-area:splitL}.splitter.v.right{grid-area:splitR}.splitter.v::after{width:3px;top:12px;bottom:12px;left:calc(50% - 1.5px)}
.splitter.h{grid-area:splitB;\1; \2; }.splitter.h::after{height:3px;left:12px;right:12px;top:calc(50% - 1.5px)}
#leftPanel{grid-area:left}#rightPanel{grid-area:right}#bottomPanel{grid-area:bottom}
.canvasWrap{grid-area:main;position:relative;background:#0b0d12;border:1px solid #1f2533;border-radius:10px;overflow:hidden;box-shadow:0 8px 30px rgba(0,0,0,.25);min-width:0;min-height:0}
canvas{position:absolute;inset:0;max-width:100%;max-height:100%;image-rendering:crisp-edges;image-rendering:pixelated;background:#fff}
#overlay{background:transparent!important;pointer-events:none}
.labelEditor{position:absolute;z-index:100;display:none;min-width:140px;border-radius:6px;border:1px solid #2a3145;background:#0f141f;color:#e6eefc;outline:none;padding:6px 8px;font:16px system-ui,sans-serif;box-shadow:0 4px 18px rgba(0,0,0,.35)}
.palette{display:grid;grid-template-columns:repeat(6,1fr);gap:8px}.sym{border:1px solid #3a4a7a;border-radius:8px;background:#f4f7ff;padding:8px;display:flex;align-items:center;justify-content:center;cursor:grab;box-shadow:inset 0 0 0 1px rgba(255,255,255,.6)}.sym img{width:40px;height:40px}.sym:hover{background:#eaf1ff}.sym.dragging{opacity:.6}.symLabel{text-align:center;font-size:11px;color:#9fb0c3;margin-top:4px}
.pass{color:var(--ok)}.fail{color:var(--bad)}
.hide-left{--left:0}.hide-right{--right:0}.hide-bottom{--bottom:0}.hide-left #leftPanel,.hide-left .splitter.v.left{display:none}.hide-right #rightPanel,.hide-right .splitter.v.right{display:none}.hide-bottom #bottomPanel,.hide-bottom .splitter.h{display:none}
#leftPanel #panToggle, #leftPanel #highlightToggle, #leftPanel #textModeBtn, #leftPanel #eraserToggle, #leftPanel #lineToggle, #leftPanel #netLabelBtn, #leftPanel #contToggleBtn, #leftPanel #toolPan, #leftPanel #toolHighlight, #leftPanel #toolText, #leftPanel #toolEraser, #leftPanel #toolLine, #leftPanel #toolNet, #leftPanel #toolCont{display:none !important}
#leftPanel .toolstrip, #leftPanel [data-section='tools'], #leftPanel .tools-group{display:none !important}
#leftPanel h2, #leftPanel h3 { }





.retype-rect{
  position:absolute; border:1.5px dashed rgba(107,178,255,.9);
  background:rgba(107,178,255,.12); pointer-events:none; z-index:6;
}



.chip{background:var(--btn);border:1px solid rgba(255,255,255,.08);padding:6px 10px;border-radius:999px;cursor:pointer}
.chip:hover{background:var(--btnHover)}

#progressModal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9999}
#progressCard{background:var(--panel);padding:16px 18px;border-radius:12px;min-width:280px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
#progressTitle{font-weight:600;margin:0 0 10px 0}
#progressText{font-size:13px;opacity:.9;margin:4px 0 10px 0}
.progressBar{height:10px;background:#222838;border-radius:999px;overflow:hidden;border:1px solid rgba(255,255,255,.07)}
.progressBar > div{height:100%;width:0%}



header .toolbar button{display:flex;align-items:center;gap:8px;padding:8px 10px}
header .toolbar .ico{width:18px;height:18px;display:inline-grid;place-items:center;line-height:0}
header .toolbar .ico svg{width:18px;height:18px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
header .toolbar .lbl{white-space:nowrap}
@media (max-width: 900px){
  header .toolbar .lbl{display:none}
  header .toolbar button{padding:8px}
}



header .toolbar-center{
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  gap:8px 10px;
  max-width:100%;
}

header .toolbar-left, header .toolbar-right{flex:0 0 auto}



header .toolbar-center{
  display:grid;
  grid-auto-flow: column;
  grid-template-rows: repeat(2, auto);
  grid-auto-columns: max-content;
  justify-content:center;
  align-content:start;
  gap:8px 10px;
  max-width:100%;
  margin: 0 auto;
}



.panel{position:relative}
.chev{position:absolute; display:grid; place-items:center; width:26px; height:42px;
  background:var(--btn); border:1px solid #2a3145; border-radius:10px; opacity:.9; cursor:pointer;
  box-shadow:0 6px 16px rgba(0,0,0,.25); transition:opacity .2s, transform .2s z-index:50; }
.chev:hover{opacity:1}

#leftPanel .chev-left{ right:-10px; top:50%; transform:translateY(-50%); }
#rightPanel .chev-right{ left:-10px; top:50%; transform:translateY(-50%); }
#bottomPanel .chev-bottom{ left:50%; top:-12px; transform:translate(-50%, -0%); height:26px }

.chev svg, .reveal svg{ width:18px; height:18px; stroke:currentColor; fill:none; stroke-width:2; stroke-linecap:round; stroke-linejoin:round }


.reveal{position:absolute; display:none; place-items:center; width:22px; height:46px;
  background:var(--btn); border:1px solid #2a3145; border-radius:10px; cursor:pointer; opacity:.85 z-index:50; }
.reveal:hover{opacity:1}
.reveal.left{ left:6px; top:calc(var(--headerH) + 50%); transform:translateY(-50%); }
.reveal.right{ right:6px; top:calc(var(--headerH) + 50%); transform:translateY(-50%); }
.reveal.bottom{ left:50%; bottom:8px; transform:translateX(-50%); height:22px }

.hide-left .reveal.left{ display:grid }
.hide-right .reveal.right{ display:grid }
.hide-bottom .reveal.bottom{ display:grid }



header{justify-content:center}
header .toolbar-center{margin:0 auto; flex: 1 1 auto}



header{padding:8px 12px}



#splitBottom{position:relative}
#chevBottomSplit{width:44px;height:28px;border-radius:999px;background:var(--btn);border:1px solid #2a3145;box-shadow:0 6px 16px rgba(0,0,0,.3)}
#chevBottomSplit .arrow{transition:transform .15s ease}

.hide-bottom #chevBottomSplit .arrow{transform:rotate(180deg)}

.hide-bottom #bottomPanel .chev-bottom .arrow{transform:rotate(180deg)}



.net-chev-controls .row button{padding:6px 10px;border-radius:8px;border:1px solid #273148;background:#131a27;color:#e8eef7}
.net-chev-controls .row button:hover{background:#172136}


.net-chev-controls{margin:12px 0 14px 0;padding:12px;border:1px solid #222a3a;border-radius:12px;background:#101521}
.net-chev-controls .hdr{font-weight:600;margin-bottom:8px;opacity:.9}
.net-chev-controls .toggles{display:flex;gap:18px;flex-wrap:wrap;margin-bottom:8px}
.net-chev-controls .grid3{display:grid;grid-template-columns: 110px 1fr 42px;gap:8px;align-items:center;margin-bottom:8px}
.net-chev-controls .grid2{display:grid;grid-template-columns: 110px 1fr;gap:8px;align-items:center}
.net-chev-controls input[type="range"]{width:100%}
.net-chev-controls output{justify-self:end;min-width:2ch;text-align:right;opacity:.85}
.net-chev-controls select{width:100%}
.net-chev-controls .row button{padding:6px 10px;border-radius:8px;border:1px solid #273148;background:#131a27;color:#e8eef7}
.net-chev-controls .row button:hover{background:#172136}
</style>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script src="js/state.js"></script>
  <script src="js/tools.js"></script>
  <script src="js/canvas.js"></script>
  <script src="js/ui.js"></script>
  <script src="js/main.js"></script>
</head>
<body>
<header>
  <div class="toolbar toolbar-left" role="toolbar" aria-label="Panels">
    <button id="toggleLeft" class="active">Left</button>
    <button id="toggleRight" class="active">Right</button>
    <button id="toggleBottom" class="active">Bottom</button>
  </div>
  <div class="toolbar toolbar-center" role="toolbar" aria-label="Tools (Top)">
    <button id="topPan">Pan (P)</button>
    <button id="topHighlight" class="active">Highlight (H)</button>
    <button id="topText">Text (T)</button>
    <button id="topEraser">Eraser (E)</button>
    <button id="topLine">Line (L)</button>
    <button id="topNet">Net (N)</button>
    <button id="topCont">Continuity (C)</button>
  
      <button id="cleanupToggle" title="Cleanup mode (redraw black stroke over traced lines)">Cleanup</button>
      <button id="cleanupFindBtn" title="Find opens/tees">Find Opens/Tees</button>
      <button id="cleanupSettingsBtn" title="Cleanup settings">⚙</button>

      <button id="retypeToggle" title="Retype (R): box old text then type new">Retype (R)</button>
    <button id="topArrows" title="Manual Arrows">Arrows</button>
  </div>
  <div class="toolbar toolbar-right" role="toolbar" aria-label="Actions">
    <button id="fit">Fit</button>
    <button id="clear">Clear</button>
    <button id="download">PNG</button>
    <button id="scanPolishBtn" title="One-click: auto threshold → cleanup → text cleanup → auto-label VCC/GND">Scan Polish</button>
    <button id="saveProject">Save Project</button>
    <button id="openProjectBtn">Open</button>
    <button id="undoBtn" title="Undo (Ctrl+Z)">Undo</button>
    <button id="redoBtn" title="Redo (Ctrl+Y)">Redo</button>
    <input id="openProject" type="file" accept="application/json" style="display:none" />
  </div>

</header>

<div id="dock" class="dock">

  <button id="revealLeft" class="reveal left" title="Show left panel" aria-label="Show left panel">
    <svg viewBox="0 0 24 24"><polyline points="14 6 8 12 14 18"/></svg>
  </button>
  <button id="revealRight" class="reveal right" title="Show right panel" aria-label="Show right panel">
    <svg viewBox="0 0 24 24"><polyline points="10 6 16 12 10 18"/></svg>
  </button>
  <button id="revealBottom" class="reveal bottom" title="Show bottom panel" aria-label="Show bottom panel">
    <svg viewBox="0 0 24 24"><polyline points="6 10 12 16 18 10"/></svg>
  </button>

  <aside id="leftPanel" class="panel">
  <button id="chevLeft" class="chev chev-left" title="Hide left panel" aria-label="Hide left panel">
  <svg viewBox="0 0 24 24"><polyline points="14 6 8 12 14 18"/></svg>
</button>
    <div>
      <h2>1) Load schematic image</h2>
      <div class="row"><input id="file" type="file" accept="image/*"></div>
      <div id="drop" class="drop">…or drag & drop an image here</div>
      <div class="row" style="margin-top:6px;gap:6px;grid-template-columns:auto 1fr;">
        <button id="loadSample">Load sample</button>
        <div class="hint">PNG (black lines on white) gives best results. PDFs need to be exported to an image first.</div>
      </div>
    </div>

    <div>
      <h2>2) Tools</h2>
      <div class="row" style="grid-template-columns:repeat(3, auto) 1fr; gap:8px; align-items:center;">
        <button id="panToggle">Pan (P)</button>
        <button id="highlightToggle" class="active">Highlight (H)</button>
        <button id="textMode">Text (T)</button>
        <button id="eraserToggle">Eraser (E)</button>
        <button id="lineToggle">Line (L)</button>
      </div>
      <div class="row" style="grid-template-columns:repeat(2, auto) 1fr; gap:8px; align-items:center; margin-top:6px;">
        <button id="netLabelMode">Net Label (N)</button>
        <button id="contToggle">Continuity (C)</button>
        <div class="hint">Net Label: click a wire to name it. Continuity: pick two pins → pass/fail.</div>
      </div>
      <div class="row"><label for="eraserSize">Eraser size (px)</label><output id="eraserSizeVal">10</output></div>
      <input id="eraserSize" type="range" min="2" max="48" step="1" value="10">
      <div class="hint">Eraser clears the <b>active layer</b>. Hold mouse and scrub to remove highlight pixels. Use <b>Line</b> to draw straight highlight segments.</div>
    </div>

    <div>
      <h2>Tracing</h2>
      <div class="hint">Click near a thin black line to trace the connected stroke. <b>Middle-click</b> or hold <span class="kbd">Space</span> to pan. <b>Wheel = zoom</b>. Shift+Click to clear first.</div>
      <label class="inline" style="display:flex;align-items:center;gap:8px;"><input type="checkbox" id="segmentMode" checked> Stop at junctions (segment between tees/symbols)</label>
    </div>

    <div>
      <h2>Threshold</h2>
      <label class="inline"><input type="checkbox" id="autoThresh" checked> Auto-detect dark-line threshold</label>
      <div class="row"><label for="thresh">Manual threshold</label><output id="threshVal">120</output></div>
      <input id="thresh" type="range" min="0" max="255" value="120" step="1">
      <div class="row" style="grid-template-columns:auto auto 1fr; gap:8px;">
        <button id="analyze">Analyze</button>
        <div class="hint">Auto picks a value using Otsu on luminance histogram.</div>
      </div>
    </div>

    <div>
      <h2>Performance</h2>
      <label class="inline"><input type="checkbox" id="autoDown" checked> Auto-downscale large images</label>
      <div class="row"><label for="maxDim">Max dimension (px)</label><output id="maxDimVal">4096</output></div>
      <input id="maxDim" type="number" min="512" max="8192" step="128" value="4096">
    </div>

    <div class="footer">All local. No uploads.</div>
  </aside>

  <div id="splitLeft" class="splitter v left"></div>

  <main class="canvasWrap">
    <canvas id="view" width="1280" height="800"></canvas>
    <canvas id="overlay" width="1280" height="800"></canvas>
    <canvas id="arrowsCanvas" width="1280" height="800" style="pointer-events:none;background:transparent"></canvas>
    <input id="labelEditor" class="labelEditor" placeholder="Type and Enter…" />
  </main>

  <div id="splitRight" class="splitter v right"></div>

  <aside id="rightPanel" class="panel">
  <button id="chevRight" class="chev chev-right" title="Hide right panel" aria-label="Hide right panel">
  <svg viewBox="0 0 24 24"><polyline points="10 6 16 12 10 18"/></svg>
</button>
    <div class="tabs" id="rightTabs">
      <button data-tab="props" class="active">Properties</button>
      <button data-tab="layers">Layers</button>
      <button data-tab="symbols">Symbols</button>
      <button data-tab="nets">Nets</button>
    
      <button data-tab="cleanup">Cleanup</button>
    
      <button data-tab="text">Text</button>
    </div>
    <div class="sep"></div>

    <section id="tab-props" class="tabpane active">
      <div>
        <h2>Text annotations</h2>
        <div class="row" style="grid-template-columns:auto auto auto 1fr; gap:8px; align-items:center;">
          <label class="inline" style="gap:6px;">Color <input id="labelColor" type="color" value="#ffff00"></label>
          <label class="inline" style="gap:6px;">Size <output id="labelSizeVal">18</output>px</label>
        </div>
        <input id="labelSize" type="range" min="10" max="48" value="18" step="1">
        <label style="display:flex;gap:8px;align-items:center;margin-top:4px;"><input id="showAnnotations" type="checkbox" checked> Show annotations</label>
        <label style="display:flex;gap:8px;align-items:center;margin-top:4px;"><input id="showNetLabels" type="checkbox" checked> Show net labels</label>
        <label style="display:flex;gap:8px;align-items:center;margin-top:4px;"><input id="contFree" type="checkbox"> Free continuity (click any two points)</label>
      </div>

      <div>
        <h2>Highlight & Limits</h2>
        <div class="row"><label for="snap">Snap radius (px)</label><output id="snapVal">6</output></div>
        <input id="snap" type="range" min="0" max="20" value="6" step="1">
        <div class="row"><label for="alpha">Default opacity</label><output id="alphaVal">0.70</output></div>
        <input id="alpha" type="range" min="0" max="100" value="70" step="1">
        <div class="row"><label for="color">Default color</label><input id="color" type="color" value="#ff0000"></div>
        <div class="row" style="grid-template-columns:auto 1fr;">
          <button id="autoColor">Auto line color (A)</button>
          <div></div>
        </div>
        <div class="row"><label for="thickness">Highlight thickness (px)</label><output id="thicknessVal">6</output></div>
        <input id="thickness" type="range" min="1" max="24" value="6" step="1">
        <div class="row"><label for="limit">Pixel limit (×1000)</label><output id="limitVal">600</output></div>
        <input id="limit" type="range" min="20" max="5000" value="600" step="20">
        <div class="row" style="grid-template-columns:auto auto 1fr;">
          <button id="clearActive">Clear active layer</button>
          <button id="syncLayerStyle">Apply defaults to active layer</button>
        </div>
      </div>

      <div>
        <h2>Zoom & Pan</h2>
        <div class="row"><label for="zoom">Zoom</label><output id="zoomVal">100%</output></div>
        <input id="zoom" type="range" min="10" max="300" value="100" step="1">
        <div class="hint" id="meta"></div>
      </div>
    </section>

    <section id="tab-layers" class="tabpane">
      <div class="row" style="grid-template-columns:auto auto auto 1fr; gap:8px;">
        <button id="addLayer">+ Layer</button>
        <button id="delLayer">Delete</button>
        <button id="dupLayer">Duplicate</button>
      </div>
      <div class="layerList" id="layerList"></div>
      <div class="hint">Tips: click a layer row to activate it. Eye toggles visibility. Color/opacity affect rendering.</div>
    </section>

    <section id="tab-symbols" class="tabpane">
      <div>
        <h2>Palette (drag onto canvas)</h2>
        <div class="palette" id="palette"></div>
        <div class="hint">Drag one of the symbols onto the canvas. Click to select; drag to move; <span class="kbd">Delete</span> to remove; <span class="kbd">[</span>/<span class="kbd">]</span> to rotate; <span class="kbd">+</span>/<span class="kbd">-</span> to scale.</div>
      </div>
      <div class="sep"></div>
      <div>
        <h2>Placement</h2>
        <label style="display:flex;gap:8px;align-items:center;"><input id="snapGrid" type="checkbox" checked> Snap to grid</label>
        <div class="row"><label for="gridSize">Grid size (px)</label><output id="gridSizeVal">10</output></div>
        <input id="gridSize" type="range" min="4" max="40" step="1" value="10">
        <label style="display:flex;gap:8px;align-items:center;"><input id="snapLine" type="checkbox"> Snap to existing lines</label>
        <label style="display:flex;gap:8px;align-items:center;"><input type="checkbox" id="symLockLayer"> Lock moves to active layer</label>
      </div>
      <div class="sep"></div>
      <div>
        <h2>Selected symbol</h2>
        <div class="row"><label for="symSize">Size (px)</label><output id="symSizeVal">64</output></div>
        <input id="symSize" type="range" min="20" max="200" value="64" step="2">
        <div class="row" style="grid-template-columns:auto auto auto 1fr; gap:8px;">
          <button id="rotL">⟲ Rotate</button>
          <button id="rotR">⟳ Rotate</button>
          <button id="delSym">Delete</button>
        </div>
        <div class="row"><label>Symbol color</label><input id="symColor" type="color" value="#000000"></div>
        <div class="row"><label>Label text</label><input id="symLabel" type="text" placeholder="e.g., R1"></div>
        <div class="row"><label>Label size (px)</label><output id="symLabelSizeVal">16</output></div>
        <input id="symLabelSize" type="range" min="10" max="36" step="1" value="16">
        <div class="row"><label>Label color</label><input id="symLabelColor" type="color" value="#000000"></div>
      </div>
    </section>

    <section id="tab-nets" class="tabpane">
<div id="arrowsControlsPinned" class="net-chev-controls">
  <div class="hdr">Arrows &amp; Label</div>

  <div class="row toggles">
    <label><input type="checkbox" id="chkChevronEnable" checked> Arrows</label>
    <label><input type="checkbox" id="chkChevronMarch" checked> Marching</label>
    <label><input type="checkbox" id="chkLabelShow" checked> Label at start</label>
  </div>
  <div class="grid3">
    <div>Spacing</div><input type="range" id="rngChevronSpace" min="16" max="160" value="52"><output id="outChevronSpace">52</output>
    <div>Arrow Size</div><input type="range" id="rngChevronSize" min="10" max="48" value="18"><output id="outChevronSize">18</output>
    <div>Speed</div><input type="range" id="rngChevronSpeed" min="0" max="4" value="2"><output id="outChevronSpeed">2</output>
    <div>Label Size</div><input type="range" id="rngLabelSize" min="10" max="28" value="14"><output id="outLabelSize">14</output>
  </div>
  <div class="grid3">
    <div>Style</div>
    <select id="selArrowStyle">
      <option value="triangle" selected>Triangle</option>
      <option value="chevron">Chevron "»"</option>
      <option value="dots">Dots</option>
    </select>
    <span></span>
    <div>Start Offset</div><input type="range" id="rngStartOffset" min="0" max="120" value="12"><output id="outStartOffset">12</output>
    <div>Auto Density</div><label><input type="checkbox" id="chkAutoDensity" checked> Tight bends = denser arrows</label><span></span>
  </div>
  <div class="grid2">
    <div>Arrow Color</div><input type="color" id="colArrow" value="#6bb2ff">
    <div>Label BG</div><input type="color" id="colLabelBg" value="#141820">
    <div>Label Text</div><input type="color" id="colLabelFg" value="#e8eef7">
  </div>
  <div class="row" style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
    <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="chkAutoFromHighlight" checked> <span>Auto from highlight</span></label>
    <button id="btnApplyFromHighlight">Apply now</button>
    <button id="btnTestArrows">▶ Test arrows</button>
  </div>
</div>

      <div class="row" style="grid-template-columns:auto auto 1fr auto; gap:8px;">
        <button id="addNet">+ Net</button>
        <button id="delNet">Delete</button>
        <div></div>
        <button id="exportNets">Export JSON</button>
      </div>
      <div class="layerList" id="netsList"></div>
      <div class="hint">Click a net to edit. "+ Net" switches to Net Label mode; then click a wire to create it. Use the Zoom button on a row to center on that net.</div>
    </section>
    <section id="tab-cleanup" class="tabpane">
      <div class="group">
        <label class="inline"><input type="checkbox" id="cleanupEnabled"> Enable cleanup overlay</label>
      </div>
      <div class="group">
        <label class="inline">Stroke thickness <input type="range" id="cleanupThickness" min="0.5" max="12" step="0.25" value="0.75"></label>
        <span id="cleanupThicknessVal">0.75 px</span>
      </div>
      <div class="group">
        <label class="inline">Bridge gaps (blur px) <input type="range" id="cleanupBridge" min="0" max="6" step="0.25" value="0.5"></label>
        <span id="cleanupBridgeVal">0.5 px</span>
      </div>
      <div class="row" style="gap:6px; flex-wrap:wrap">
        <span class="muted" style="opacity:.85">Presets:</span>
        <button class="chip" id="cleanupPresetFine" title="0.75 px / 0.5 px">Fine</button>
        <button class="chip" id="cleanupPresetNormal" title="1.5 px / 1.0 px">Normal</button>
        <button class="chip" id="cleanupPresetBold" title="2.5 px / 1.5 px">Bold</button>
      </div>
      <div class="group">
        <label class="inline"><input type="checkbox" id="cleanupAuto" checked> Auto after trace</label>
      </div>
      <div class="group">
        <label class="inline"><input type="checkbox" id="cleanupIgnoreSymbols"> Ignore symbols while cleaning</label>
      </div>
      <div class="row" style="gap:8px;">
        <button id="cleanupRunNow">Run cleanup now</button>
        <button id="cleanupFindBtn">Find Opens/Tees</button>
        <button id="cleanupClearMarkers" title="Clear markers">Clear markers</button>
      </div>
      <div class="group" style="margin-top:8px;">
        <label class="inline"><input type="checkbox" id="junctionNormalize"> Normalize junction dots</label>
      </div>
      <div class="group">
        <label class="inline">Dot radius <input type="range" id="junctionRadius" min="2" max="14" step="0.5" value="6"></label>
        <span id="junctionRadiusVal">6 px</span>
      </div>

      <p class="muted">Cleanup draws a constant-thickness black stroke along traced masks, bridging tiny gaps and painting over symbols/text.</p>
    </section>
    <section id="tab-text" class="tabpane">
      <h2>Text cleanup</h2>
      <div class="group">
        <label class="inline"><input type="checkbox" id="textCleanEnabled" checked> Enable text-only cleanup</label>
      </div>
      <div class="group">
        <label class="inline">Tile size <input type="range" id="textTile" min="12" max="64" step="4" value="28"></label>
        <span id="textTileVal">28 px</span>
      </div>
      <div class="group">
        <label class="inline">Local offset (C) <input type="range" id="textC" min="0" max="40" step="1" value="12"></label>
        <span id="textCVal">12</span>
      </div>
      <div class="group">
        <label class="inline">Close radius <input type="range" id="textClose" min="0" max="2" step="0.25" value="0.5"></label>
        <span id="textCloseVal">0.5 px</span>
      </div>
      <div class="group">
        <label class="inline">Despeckle (neighbors) <input type="range" id="textSpeckle" min="0" max="4" step="1" value="2"></label>
        <span id="textSpeckleVal">2</span>
      </div>
      <div class="group">
        <label class="inline">Exclude traced lines <input type="checkbox" id="textExcludeLines" checked></label>
      </div>
      <div class="row" style="gap:8px;">
        <button id="textBuildBtn">Run Now</button>
        <button id="textClearBtn">Clear</button>
      </div>
      <p class="muted">      <div class="row" style="gap:8px; margin-top:8px;">
        <button id="ocrSelectBtn" title="Drag a box to OCR (O)">OCR selection</button>
        <button id="ocrPageBtn" title="OCR the entire image (slower)">OCR page</button>
        <label class="inline" style="display:flex; align-items:center; gap:6px;">
          <input type="checkbox" id="ocrAttachNet" checked> Attach OCR near wires as Net Label
        </label>
      </div>
This pass cleans only raster text: adaptive binarize, close tiny gaps, drop speckle, and draw crisp black text over a white underlay. Use "Retype (R)" to replace text manually.</p>
      <h3 style="margin-top:10px;">Retype patches</h3>
      <div class="row" style="gap:8px;">
        <button id="retypeToggle2">Retype Mode</button>
        <button id="clearRetypePatches">Clear Patches</button>
      </div>
    </section>


  </aside>

  <div id="splitBottom" class="splitter h">

    <button id="chevBottomSplit" class="chev chev-bottom" title="Hide bottom panel" aria-label="Hide bottom panel" style="left:50%; top:50%; transform:translate(-50%,-50%); height:22px; width:36px;"><span class="arrow"><svg viewBox="0 0 24 24"><polyline points="6 10 12 16 18 10"/></svg></span></button>
</div>
  <section id="bottomPanel" class="panel">
  <button id="chevBottom" class="chev chev-bottom" title="Hide bottom panel" aria-label="Hide bottom panel"><span class="arrow"><svg viewBox="0 0 24 24"><polyline points="6 10 12 16 18 10"/></svg></span></button>
    <div class="tabs" id="bottomTabs">
      <button data-tab="history" class="active">History</button>
      <button data-tab="console">Console</button>
      <button data-tab="tests">Self-tests</button>
    </div>
    <div class="sep"></div>

    <section id="tab-history" class="tabpane active">
      <div class="row" style="grid-template-columns:auto 1fr;gap:8px;align-items:center;">
        <h2 style="margin:0;">History</h2>
        <div style="text-align:right;"><button id="clearHistory">Clear history</button></div>
      </div>
      <div id="historyList"></div>
    </section>

    <section id="tab-console" class="tabpane">
      <div class="row" style="grid-template-columns:1fr auto;gap:8px;">
        <input id="consoleIn" placeholder="Type a command (help, clear, stats, layers, symbols, nets)" />
        <button id="consoleRun">Run</button>
      </div>
      <pre id="consoleOut"></pre>
    </section>

    <section id="tab-tests" class="tabpane">
      <div class="row" style="grid-template-columns:auto 1fr;gap:8px;align-items:center;">
        <h2 style="margin:0;">Self-tests</h2>
        <div style="text-align:right;"><button id="runTests">Run self-test</button></div>
      </div>
      <div class="hint">Quick check that tracing + overlay + autos are working.</div>
      <div id="testLog"></div>
    </section>
  </section>
</div>

</body>
</html>
