<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Schematic Highlighter — Docking + Tabs (v3.2f: annotation editor fix)</title>
<link rel="stylesheet" href="css/style.css">
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>
<body>
<header>
  <div class="toolbar toolbar-left" role="toolbar" aria-label="Panels">
    <button id="toggleLeft" class="active">Left</button>
    <button id="toggleRight" class="active">Right</button>
    <button id="toggleBottom" class="active">Bottom</button>
  </div>
  <div class="toolbar toolbar-center" role="toolbar" aria-label="Tools (Top)">
    <button id="topPan">Pan (P)</button>
    <button id="topHighlight" class="active">Highlight (H)</button>
    <button id="topText">Text (T)</button>
    <button id="topEraser">Eraser (E)</button>
    <button id="topLine">Line (L)</button>
    <button id="topNet">Net (N)</button>
    <button id="topCont">Continuity (C)</button>
  
      <button id="cleanupToggle" title="Cleanup mode (redraw black stroke over traced lines)">Cleanup</button>
      <button id="cleanupFindBtn" title="Find opens/tees">Find Opens/Tees</button>
      <button id="cleanupSettingsBtn" title="Cleanup settings">⚙</button>

      <button id="retypeToggle" title="Retype (R): box old text then type new">Retype (R)</button>
    <button id="topArrows" title="Manual Arrows">Arrows</button>
  </div>
  <div class="toolbar toolbar-right" role="toolbar" aria-label="Actions">
    <button id="fit">Fit</button>
    <button id="clear">Clear</button>
    <button id="download">PNG</button>
    <button id="scanPolishBtn" title="One-click: auto threshold → cleanup → text cleanup → auto-label VCC/GND">Scan Polish</button>
    <button id="saveProject">Save Project</button>
    <button id="openProjectBtn">Open</button>
    <button id="undoBtn" title="Undo (Ctrl+Z)">Undo</button>
    <button id="redoBtn" title="Redo (Ctrl+Y)">Redo</button>
    <input id="openProject" type="file" accept="application/json" style="display:none" />
  </div>

</header>

<div id="dock" class="dock">

  <button id="revealLeft" class="reveal left" title="Show left panel" aria-label="Show left panel">
    <svg viewBox="0 0 24 24"><polyline points="14 6 8 12 14 18"/></svg>
  </button>
  <button id="revealRight" class="reveal right" title="Show right panel" aria-label="Show right panel">
    <svg viewBox="0 0 24 24"><polyline points="10 6 16 12 10 18"/></svg>
  </button>
  <button id="revealBottom" class="reveal bottom" title="Show bottom panel" aria-label="Show bottom panel">
    <svg viewBox="0 0 24 24"><polyline points="6 10 12 16 18 10"/></svg>
  </button>

  <aside id="leftPanel" class="panel">
  <button id="chevLeft" class="chev chev-left" title="Hide left panel" aria-label="Hide left panel">
  <svg viewBox="0 0 24 24"><polyline points="14 6 8 12 14 18"/></svg>
</button>
    <div>
      <h2>1) Load schematic image</h2>
      <div class="row"><input id="file" type="file" accept="image/*"></div>
      <div id="drop" class="drop">…or drag & drop an image here</div>
      <div class="row" style="margin-top:6px;gap:6px;grid-template-columns:auto 1fr;">
        <button id="loadSample">Load sample</button>
        <div class="hint">PNG (black lines on white) gives best results. PDFs need to be exported to an image first.</div>
      </div>
    </div>

    <div>
      <h2>2) Tools</h2>
      <div class="row" style="grid-template-columns:repeat(3, auto) 1fr; gap:8px; align-items:center;">
        <button id="panToggle">Pan (P)</button>
        <button id="highlightToggle" class="active">Highlight (H)</button>
        <button id="textMode">Text (T)</button>
        <button id="eraserToggle">Eraser (E)</button>
        <button id="lineToggle">Line (L)</button>
      </div>
      <div class="row" style="grid-template-columns:repeat(2, auto) 1fr; gap:8px; align-items:center; margin-top:6px;">
        <button id="netLabelMode">Net Label (N)</button>
        <button id="contToggle">Continuity (C)</button>
        <div class="hint">Net Label: click a wire to name it. Continuity: pick two pins → pass/fail.</div>
      </div>
      <div class="row"><label for="eraserSize">Eraser size (px)</label><output id="eraserSizeVal">10</output></div>
      <input id="eraserSize" type="range" min="2" max="48" step="1" value="10">
      <div class="row"><label class="inline" style="display:flex;align-items:center;gap:6px;"><input id="eraseImageTarget" type="checkbox"> Erase base image</label></div>
      <div class="hint">Eraser clears the <b>active layer</b>. Enable “Erase base image” to remove pixels from the loaded image. Use <b>Line</b> to draw straight highlight segments.</div>
    </div>

    <div>
      <h2>Tracing</h2>
      <div class="hint">Click near a thin black line to trace the connected stroke. <b>Middle-click</b> or hold <span class="kbd">Space</span> to pan. <b>Wheel = zoom</b>. Shift+Click to clear first.</div>
      <label class="inline" style="display:flex;align-items:center;gap:8px;"><input type="checkbox" id="segmentMode" checked> Stop at junctions (segment between tees/symbols)</label>
    </div>

    <div>
      <h2>Threshold</h2>
      <label class="inline"><input type="checkbox" id="autoThresh" checked> Auto-detect dark-line threshold</label>
      <div class="row"><label for="thresh">Manual threshold</label><output id="threshVal">120</output></div>
      <input id="thresh" type="range" min="0" max="255" value="120" step="1">
      <div class="row" style="grid-template-columns:auto auto 1fr; gap:8px;">
        <button id="analyze">Analyze</button>
        <div class="hint">Auto picks a value using Otsu on luminance histogram.</div>
      </div>
    </div>

    <div>
      <h2>Performance</h2>
      <label class="inline"><input type="checkbox" id="autoDown" checked> Auto-downscale large images</label>
      <div class="row"><label for="maxDim">Max dimension (px)</label><output id="maxDimVal">4096</output></div>
      <input id="maxDim" type="number" min="512" max="8192" step="128" value="4096">
    </div>

    <div class="footer">All local. No uploads.</div>
  </aside>

  <div id="splitLeft" class="splitter v left"></div>

  <main class="canvasWrap">
    <canvas id="view" width="1280" height="800"></canvas>
    <canvas id="overlay" width="1280" height="800"></canvas>
    <canvas id="arrowsCanvas" width="1280" height="800" style="pointer-events:none;background:transparent"></canvas>
    <input id="labelEditor" class="labelEditor" placeholder="Type and Enter…" />
  </main>

  <div id="splitRight" class="splitter v right"></div>

  <aside id="rightPanel" class="panel">
  <button id="chevRight" class="chev chev-right" title="Hide right panel" aria-label="Hide right panel">
  <svg viewBox="0 0 24 24"><polyline points="10 6 16 12 10 18"/></svg>
</button>
    <div class="tabs" id="rightTabs">
      <button data-tab="props" class="active">Properties</button>
      <button data-tab="layers">Layers</button>
      <button data-tab="symbols">Symbols</button>
      <button data-tab="nets">Nets</button>
    
      <button data-tab="cleanup">Cleanup</button>
    
      <button data-tab="text">Text</button>
    </div>
    <div class="sep"></div>

    <section id="tab-props" class="tabpane active">
      <div>
        <h2>Text annotations</h2>
        <div class="row" style="grid-template-columns:auto auto auto 1fr; gap:8px; align-items:center;">
          <label class="inline" style="gap:6px;">Color <input id="labelColor" type="color" value="#ffff00"></label>
          <label class="inline" style="gap:6px;">Size <output id="labelSizeVal">18</output>px</label>
        </div>
        <input id="labelSize" type="range" min="10" max="48" value="18" step="1">
        <label style="display:flex;gap:8px;align-items:center;margin-top:4px;"><input id="showAnnotations" type="checkbox" checked> Show annotations</label>
        <label style="display:flex;gap:8px;align-items:center;margin-top:4px;"><input id="showNetLabels" type="checkbox" checked> Show net labels</label>
        <label style="display:flex;gap:8px;align-items:center;margin-top:4px;"><input id="contFree" type="checkbox"> Free continuity (click any two points)</label>
      </div>

      <div>
        <h2>Highlight & Limits</h2>
        <div class="row"><label for="snap">Snap radius (px)</label><output id="snapVal">6</output></div>
        <input id="snap" type="range" min="0" max="20" value="6" step="1">
        <div class="row"><label for="alpha">Default opacity</label><output id="alphaVal">0.70</output></div>
        <input id="alpha" type="range" min="0" max="100" value="70" step="1">
        <div class="row"><label for="color">Default color</label><input id="color" type="color" value="#ff0000"></div>
        <div class="row" style="grid-template-columns:auto 1fr;">
          <button id="autoColor">Auto line color (A)</button>
          <div></div>
        </div>
        <div class="row"><label for="thickness">Highlight thickness (px)</label><output id="thicknessVal">6</output></div>
        <input id="thickness" type="range" min="1" max="24" value="6" step="1">
        <div class="row"><label for="limit">Pixel limit (×1000)</label><output id="limitVal">600</output></div>
        <input id="limit" type="range" min="20" max="5000" value="600" step="20">
        <div class="row" style="grid-template-columns:auto auto 1fr;">
          <button id="clearActive">Clear active layer</button>
          <button id="syncLayerStyle">Apply defaults to active layer</button>
        </div>
      </div>

      <div>
        <h2>Zoom & Pan</h2>
        <div class="row"><label for="zoom">Zoom</label><output id="zoomVal">100%</output></div>
        <input id="zoom" type="range" min="10" max="300" value="100" step="1">
        <div class="hint" id="meta"></div>
      </div>
    </section>

    <section id="tab-layers" class="tabpane">
      <div class="row" style="grid-template-columns:auto auto auto 1fr; gap:8px;">
        <button id="addLayer">+ Layer</button>
        <button id="delLayer">Delete</button>
        <button id="dupLayer">Duplicate</button>
      </div>
      <div class="layerList" id="layerList"></div>
      <div class="hint">Tips: click a layer row to activate it. Eye toggles visibility. Color/opacity affect rendering.</div>
    </section>

    <section id="tab-symbols" class="tabpane">
      <div>
        <h2>Palette (drag onto canvas)</h2>
        <div class="palette" id="palette"></div>
        <div class="hint">Drag one of the symbols onto the canvas. Click to select; drag to move; <span class="kbd">Delete</span> to remove; <span class="kbd">[</span>/<span class="kbd">]</span> to rotate; <span class="kbd">+</span>/<span class="kbd">-</span> to scale.</div>
      </div>
      <div class="sep"></div>
      <div>
        <h2>Placement</h2>
        <label style="display:flex;gap:8px;align-items:center;"><input id="snapGrid" type="checkbox" checked> Snap to grid</label>
        <div class="row"><label for="gridSize">Grid size (px)</label><output id="gridSizeVal">10</output></div>
        <input id="gridSize" type="range" min="4" max="40" step="1" value="10">
        <label style="display:flex;gap:8px;align-items:center;"><input id="snapLine" type="checkbox"> Snap to existing lines</label>
        <label style="display:flex;gap:8px;align-items:center;"><input type="checkbox" id="symLockLayer"> Lock moves to active layer</label>
      </div>
      <div class="sep"></div>
      <div>
        <h2>Selected symbol</h2>
        <div class="row"><label for="symSize">Size (px)</label><output id="symSizeVal">64</output></div>
        <input id="symSize" type="range" min="20" max="200" value="64" step="2">
        <div class="row" style="grid-template-columns:auto auto auto 1fr; gap:8px;">
          <button id="rotL">⟲ Rotate</button>
          <button id="rotR">⟳ Rotate</button>
          <button id="delSym">Delete</button>
        </div>
        <div class="row"><label>Symbol color</label><input id="symColor" type="color" value="#000000"></div>
        <div class="row"><label>Label text</label><input id="symLabel" type="text" placeholder="e.g., R1"></div>
        <div class="row"><label>Label size (px)</label><output id="symLabelSizeVal">16</output></div>
        <input id="symLabelSize" type="range" min="10" max="36" step="1" value="16">
        <div class="row"><label>Label color</label><input id="symLabelColor" type="color" value="#000000"></div>
      </div>
    </section>

    <section id="tab-nets" class="tabpane">
<!-- Patch: Arrows & Label (pinned at top of Nets) -->
<div id="arrowsControlsPinned" class="net-chev-controls">
  <div class="hdr">Arrows &amp; Label</div>

  <div class="row toggles">
    <label><input type="checkbox" id="chkChevronEnable" checked> Arrows</label>
    <label><input type="checkbox" id="chkChevronMarch" checked> Marching</label>
    <label><input type="checkbox" id="chkLabelShow" checked> Label at start</label>
  </div>
  <div class="grid3">
    <div>Spacing</div><input type="range" id="rngChevronSpace" min="16" max="160" value="52"><output id="outChevronSpace">52</output>
    <div>Arrow Size</div><input type="range" id="rngChevronSize" min="10" max="48" value="18"><output id="outChevronSize">18</output>
    <div>Speed</div><input type="range" id="rngChevronSpeed" min="0" max="4" value="2"><output id="outChevronSpeed">2</output>
    <div>Label Size</div><input type="range" id="rngLabelSize" min="10" max="28" value="14"><output id="outLabelSize">14</output>
  </div>
  <div class="grid3">
    <div>Style</div>
    <select id="selArrowStyle">
      <option value="triangle" selected>Triangle</option>
      <option value="chevron">Chevron “»”</option>
      <option value="dots">Dots</option>
    </select>
    <span></span>
    <div>Start Offset</div><input type="range" id="rngStartOffset" min="0" max="120" value="12"><output id="outStartOffset">12</output>
    <div>Auto Density</div><label><input type="checkbox" id="chkAutoDensity" checked> Tight bends = denser arrows</label><span></span>
  </div>
  <div class="grid2">
    <div>Arrow Color</div><input type="color" id="colArrow" value="#6bb2ff">
    <div>Label BG</div><input type="color" id="colLabelBg" value="#141820">
    <div>Label Text</div><input type="color" id="colLabelFg" value="#e8eef7">
  </div>
  <div class="row" style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
    <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="chkAutoFromHighlight" checked> <span>Auto from highlight</span></label>
    <button id="btnApplyFromHighlight">Apply now</button>
    <button id="btnTestArrows">▶ Test arrows</button>
  </div>
</div>

      <div class="row" style="grid-template-columns:auto auto 1fr auto; gap:8px;">
        <button id="addNet">+ Net</button>
        <button id="delNet">Delete</button>
        <div></div>
        <button id="exportNets">Export JSON</button>
      </div>
      <div class="layerList" id="netsList"></div>
      <div class="hint">Click a net to edit. “+ Net” switches to Net Label mode; then click a wire to create it. Use the Zoom button on a row to center on that net.</div>
    </section>
    <section id="tab-cleanup" class="tabpane">
      <div class="group">
        <label class="inline"><input type="checkbox" id="cleanupEnabled"> Enable cleanup overlay</label>
      </div>
      <div class="group">
        <label class="inline">Stroke thickness <input type="range" id="cleanupThickness" min="0.5" max="12" step="0.25" value="0.75"></label>
        <span id="cleanupThicknessVal">0.75 px</span>
      </div>
      <div class="group">
        <label class="inline">Bridge gaps (blur px) <input type="range" id="cleanupBridge" min="0" max="6" step="0.25" value="0.5"></label>
        <span id="cleanupBridgeVal">0.5 px</span>
      </div>
      <div class="row" style="gap:6px; flex-wrap:wrap">
        <span class="muted" style="opacity:.85">Presets:</span>
        <button class="chip" id="cleanupPresetFine" title="0.75 px / 0.5 px">Fine</button>
        <button class="chip" id="cleanupPresetNormal" title="1.5 px / 1.0 px">Normal</button>
        <button class="chip" id="cleanupPresetBold" title="2.5 px / 1.5 px">Bold</button>
      </div>
      <div class="group">
        <label class="inline"><input type="checkbox" id="cleanupAuto" checked> Auto after trace</label>
      </div>
      <div class="group">
        <label class="inline"><input type="checkbox" id="cleanupIgnoreSymbols"> Ignore symbols while cleaning</label>
      </div>
      <div class="row" style="gap:8px;">
        <button id="cleanupRunNow">Run cleanup now</button>
        <button id="cleanupFindBtn">Find Opens/Tees</button>
        <button id="cleanupClearMarkers" title="Clear markers">Clear markers</button>
      </div>
      <div class="group" style="margin-top:8px;">
        <label class="inline"><input type="checkbox" id="junctionNormalize"> Normalize junction dots</label>
      </div>
      <div class="group">
        <label class="inline">Dot radius <input type="range" id="junctionRadius" min="2" max="14" step="0.5" value="6"></label>
        <span id="junctionRadiusVal">6 px</span>
      </div>

      <p class="muted">Cleanup draws a constant-thickness black stroke along traced masks, bridging tiny gaps and painting over symbols/text.</p>
    </section>
    <section id="tab-text" class="tabpane">
      <h2>Text cleanup</h2>
      <div class="group">
        <label class="inline"><input type="checkbox" id="textCleanEnabled" checked> Enable text-only cleanup</label>
      </div>
      <div class="group">
        <label class="inline">Tile size <input type="range" id="textTile" min="12" max="64" step="4" value="28"></label>
        <span id="textTileVal">28 px</span>
      </div>
      <div class="group">
        <label class="inline">Local offset (C) <input type="range" id="textC" min="0" max="40" step="1" value="12"></label>
        <span id="textCVal">12</span>
      </div>
      <div class="group">
        <label class="inline">Close radius <input type="range" id="textClose" min="0" max="2" step="0.25" value="0.5"></label>
        <span id="textCloseVal">0.5 px</span>
      </div>
      <div class="group">
        <label class="inline">Despeckle (neighbors) <input type="range" id="textSpeckle" min="0" max="4" step="1" value="2"></label>
        <span id="textSpeckleVal">2</span>
      </div>
      <div class="group">
        <label class="inline">Exclude traced lines <input type="checkbox" id="textExcludeLines" checked></label>
      </div>
      <div class="row" style="gap:8px;">
        <button id="textBuildBtn">Run Now</button>
        <button id="textClearBtn">Clear</button>
      </div>
      <p class="muted">      <div class="row" style="gap:8px; margin-top:8px;">
        <button id="ocrSelectBtn" title="Drag a box to OCR (O)">OCR selection</button>
        <button id="ocrPageBtn" title="OCR the entire image (slower)">OCR page</button>
        <label class="inline" style="display:flex; align-items:center; gap:6px;">
          <input type="checkbox" id="ocrAttachNet" checked> Attach OCR near wires as Net Label
        </label>
      </div>
This pass cleans only raster text: adaptive binarize, close tiny gaps, drop speckle, and draw crisp black text over a white underlay. Use “Retype (R)” to replace text manually.</p>
      <h3 style="margin-top:10px;">Retype patches</h3>
      <div class="row" style="gap:8px;">
        <button id="retypeToggle2">Retype Mode</button>
        <button id="clearRetypePatches">Clear Patches</button>
      </div>
    </section>


  </aside>

  <div id="splitBottom" class="splitter h">

    <button id="chevBottomSplit" class="chev chev-bottom" title="Hide bottom panel" aria-label="Hide bottom panel" style="left:50%; top:50%; transform:translate(-50%,-50%); height:22px; width:36px;"><span class="arrow"><svg viewBox="0 0 24 24"><polyline points="6 10 12 16 18 10"/></svg></span></button>
</div>
  <section id="bottomPanel" class="panel">
  <button id="chevBottom" class="chev chev-bottom" title="Hide bottom panel" aria-label="Hide bottom panel"><span class="arrow"><svg viewBox="0 0 24 24"><polyline points="6 10 12 16 18 10"/></svg></span></button>
    <div class="tabs" id="bottomTabs">
      <button data-tab="history" class="active">History</button>
      <button data-tab="console">Console</button>
      <button data-tab="tests">Self-tests</button>
    </div>
    <div class="sep"></div>

    <section id="tab-history" class="tabpane active">
      <div class="row" style="grid-template-columns:auto 1fr;gap:8px;align-items:center;">
        <h2 style="margin:0;">History</h2>
        <div style="text-align:right;"><button id="clearHistory">Clear history</button></div>
      </div>
      <div id="historyList"></div>
    </section>

    <section id="tab-console" class="tabpane">
      <div class="row" style="grid-template-columns:1fr auto;gap:8px;">
        <input id="consoleIn" placeholder="Type a command (help, clear, stats, layers, symbols, nets)" />
        <button id="consoleRun">Run</button>
      </div>
      <pre id="consoleOut"></pre>
    </section>

    <section id="tab-tests" class="tabpane">
      <div class="row" style="grid-template-columns:auto 1fr;gap:8px;align-items:center;">
        <h2 style="margin:0;">Self-tests</h2>
        <div style="text-align:right;"><button id="runTests">Run self-test</button></div>
      </div>
      <div class="hint">Quick check that tracing + overlay + autos are working.</div>
      <div id="testLog"></div>
    </section>
  </section>
</div>

<script src="js/state.js"></script>
<script src="js/tools.js"></script>
<script src="js/canvas.js"></script>
<script src="js/ui.js"></script>
<script src="js/main.js"></script>

</body>
</html>
